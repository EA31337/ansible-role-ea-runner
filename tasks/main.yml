---
- name: Install winbind package
  ansible.builtin.apt:
    allow_unauthenticated: true
    install_recommends: "{{ 'yes' if wine_install_recommends else 'no' }}"
    name: '{{ item }}'
    state: present
    update_cache: true
  become: true
  with_items:
    - winbind
- name: Query MT platform path
  changed_when: false
  find:
    paths: '{{ ansible_env.HOME }}/.wine'
    patterns: >-
      '{{ "terminal.exe" if ea_runner_mt_version == 4 \
      else "terminal64.exe" }}'
    recurse: true
  register: cmd_reg_mt_path
- name: Set MT platform path
  set_fact:
    ea_runner_mt_path: "{{ cmd_reg_mt_path.files[0].path | dirname }}"
- name: Set MT platform's Terminal path
  set_fact:
    ea_runner_mt_terminal_path: "{{ cmd_reg_mt_path.files[0].path }}"
- name: Convert MT path 1 to Unix
  changed_when: false
  # noqa command-instead-of-shell
  shell: 'DISPLAY={{ xvfb_display }} winepath {{ ea_runner_mt_path | quote }}'
  register: cmd_winepath_mt_path
  when: ansible_os_family != "Windows"
- name: Convert MT path 2 to Unix
  changed_when: false
  # noqa command-instead-of-shell
  shell: 'DISPLAY={{ xvfb_display }} winepath
    {{ ea_runner_mt_terminal_path | quote }}'
  register: cmd_winepath_mt_terminal_path
  when: ansible_os_family != "Windows"
- name: Set MT platform path 1 for Unix
  set_fact:
    ea_runner_mt_path: "{{ cmd_winepath_mt_path.stdout }}"
  when: ansible_os_family != "Windows"
- name: Set MT platform path 2 for Unix
  set_fact:
    ea_runner_mt_terminal_path: "{{ cmd_winepath_mt_terminal_path.stdout }}"
  when: ansible_os_family != "Windows"
- name: Copy tester.ini template
  ansible.builtin.template:
    dest: '{{ ea_runner_mt_path }}/tester.ini'
    mode: 0644
    src: '{{ ea_runner_mt_version }}/tester.ini.j2'
- name: Debug
  ansible.builtin.debug:
    msg: 'cd {{ ea_runner_mt_path | quote }} && DISPLAY={{ xvfb_display }}
      {{ ea_runner_cmd_prefix | quote }}
      {{ ea_runner_mt_terminal_path | quote }} "/config:tester.ini"'
- name: Running terminal
  changed_when: false
  # noqa command-instead-of-shell
  shell: 'cd {{ ea_runner_mt_path | quote }} && DISPLAY={{ xvfb_display }}
    {{ ea_runner_cmd_prefix | quote }} {{ ea_runner_mt_terminal_path | quote }}
    "/config:tester.ini"'
