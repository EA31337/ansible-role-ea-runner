---
- name: Install winbind package
  ansible.builtin.apt:
    allow_unauthenticated: true
    install_recommends: "{{ 'yes' if wine_install_recommends else 'no' }}"
    name: '{{ item }}'
    state: present
    update_cache: true
  become: true
  with_items:
    - winbind
- name: Query MT platform path
  changed_when: false
  find:
    paths: '{{ ansible_env.HOME }}/.wine'
    patterns: '{{ mt_runner_mt_files[ea_runner_mt_version].terminal }}'
    recurse: true
  register: mt_path_terminal
- name: Set MT platform path
  set_fact:
    ea_runner_mt_path: "{{ mt_path_terminal.files[0].path | dirname }}"
- name: Set MT platform's Terminal path
  set_fact:
    ea_runner_mt_terminal_path: "{{ mt_path_terminal.files[0].path }}"
- name: Convert MT path 1 to Unix
  changed_when: false
  # noqa command-instead-of-shell
  shell: 'DISPLAY={{ xvfb_display }} winepath {{ ea_runner_mt_path | quote }}'
  register: cmd_winepath_mt_path
  when: ansible_os_family != "Windows"
- name: Convert MT path 2 to Unix
  changed_when: false
  # noqa command-instead-of-shell
  shell: 'DISPLAY={{ xvfb_display }} winepath
    {{ ea_runner_mt_terminal_path | quote }}'
  register: cmd_winepath_mt_terminal_path
  when: ansible_os_family != "Windows"
- name: Set MT platform path 1 for Unix
  set_fact:
    ea_runner_mt_path: "{{ cmd_winepath_mt_path.stdout }}"
  when: ansible_os_family != "Windows"
- name: Set MT platform path 2 for Unix
  set_fact:
    ea_runner_mt_terminal_path: "{{ cmd_winepath_mt_terminal_path.stdout }}"
  when: ansible_os_family != "Windows"
- name: Copy tester.ini template
  ansible.builtin.template:
    dest: '{{ ea_runner_mt_path }}/tester.ini'
    mode: 0644
    src: '{{ ea_runner_mt_version }}/tester.ini.j2'
- name: Run Terminal
  changed_when: false
  # noqa command-instead-of-shell
  shell:
    chdir: '{{ ea_runner_mt_path }}'
    cmd: >-
      DISPLAY={{ xvfb_display }}
      {{ ea_runner_cmd_prefix | quote }}
      {{ ea_runner_mt_terminal_path | quote }}
      "/config:tester.ini"
